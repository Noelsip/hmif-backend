name: Deploy to VPS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üöÄ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e
            echo "üîÑ Starting deployment process..."
            
            # Navigate to project directory
            cd ${{ secrets.VPS_PATH }}
            
            # Show current status
            echo "üìç Current directory: $(pwd)"
            echo "üåø Current branch: $(git branch --show-current)"
            echo "üìù Last commit: $(git log -1 --oneline)"
            
            # Stash any local changes
            git stash -u 2>/dev/null || true
            
            # Pull latest changes
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            
            # ‚úÖ CREATE .env.production.local if not exists
            if [ ! -f ".env.production.local" ]; then
                echo "üìù Creating .env.production.local..."
                cat > .env.production.local << 'EOF'
            DUCKDNS_DOMAIN=${{ secrets.DUCKDNS_DOMAIN }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            IMAGEKIT_PUBLIC_KEY=${{ secrets.IMAGEKIT_PUBLIC_KEY }}
            IMAGEKIT_PRIVATE_KEY=${{ secrets.IMAGEKIT_PRIVATE_KEY }}
            IMAGEKIT_URL_ENDPOINT=${{ secrets.IMAGEKIT_URL_ENDPOINT }}
            ADMIN_EMAILS=${{ secrets.ADMIN_EMAILS }}
            EOF
                echo "‚úÖ .env.production.local created"
            else
                echo "‚úÖ .env.production.local already exists"
            fi
            
            # Make deploy script executable
            chmod +x auto-deploy.sh
            
            # Run deployment
            echo "üöÄ Running auto-deploy script..."
            ./auto-deploy.sh
            
            echo "‚úÖ Deployment completed successfully!"

      - name: üè• Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          timeout: 30s
          script: |
            sleep 10
            if curl -f -s http://localhost:3000/health > /dev/null; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ùå Health check failed!"
              cd ${{ secrets.VPS_PATH }}
              docker compose logs --tail 20 app
              exit 1
            fi