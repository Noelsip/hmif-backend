name: Deploy to VPS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸš€ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e
            echo "ğŸ”„ Starting deployment process..."
            
            # Navigate to project directory
            cd ${{ secrets.VPS_PATH }}
            
            # Show current status
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸŒ¿ Current branch: $(git branch --show-current)"
            echo "ğŸ“ Last commit: $(git log -1 --oneline)"
            
            # Stash any local changes
            git stash -u 2>/dev/null || true
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            
            # âœ… CREATE/UPDATE .env.production.local with REAL values
            echo "ğŸ“ Creating/updating .env.production.local with production values..."
            cat > .env.production.local << EOF
            DUCKDNS_DOMAIN=${{ secrets.DUCKDNS_DOMAIN }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            IMAGEKIT_PUBLIC_KEY=${{ secrets.IMAGEKIT_PUBLIC_KEY }}
            IMAGEKIT_PRIVATE_KEY=${{ secrets.IMAGEKIT_PRIVATE_KEY }}
            IMAGEKIT_URL_ENDPOINT=${{ secrets.IMAGEKIT_URL_ENDPOINT }}
            ADMIN_EMAILS=${{ secrets.ADMIN_EMAILS }}
            EOF
            
            echo "âœ… .env.production.local updated with real production values"
            
            # Validate that secrets are not empty
            if [ -z "${{ secrets.DUCKDNS_DOMAIN }}" ]; then
                echo "âŒ DUCKDNS_DOMAIN secret is not set in GitHub!"
                echo "ğŸ’¡ Go to Settings > Secrets and variables > Actions"
                echo "ğŸ’¡ Add DUCKDNS_DOMAIN=yourdomain.duckdns.org"
                exit 1
            fi
            
            if [ -z "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
                echo "âŒ GOOGLE_CLIENT_ID secret is not set in GitHub!"
                exit 1
            fi
            
            # Make deploy script executable
            chmod +x auto-deploy.sh
            
            # Run deployment
            echo "ğŸš€ Running auto-deploy script..."
            ./auto-deploy.sh
            
            echo "âœ… Deployment completed successfully!"

      - name: ğŸ¥ Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22
          timeout: 30s
          script: |
            sleep 15
            if curl -f -s http://localhost:3000/health > /dev/null; then
              echo "âœ… Health check passed!"
              echo "ğŸŒ Application is live!"
            else
              echo "âŒ Health check failed!"
              cd ${{ secrets.VPS_PATH }}
              echo "ğŸ“‹ Container status:"
              docker compose ps
              echo "ğŸ“‹ App logs:"
              docker compose logs --tail 20 app
              exit 1
            fi